<!DOCTYPE html>
<html>
  <head>
    <title>Snake</title>

    <!-- Docs: https://hyperscript.org/docs -->
    <script src="//unpkg.com/hyperscript.org@0.9.12"></script>
    <script src="//cdn.tailwindcss.com"></script>

    <script type="text/hyperscript">
      behavior Repeat(amount)
        init 
          repeat amount times index i
            call my.content.cloneNode(true)
            set fragment to the result 
            put i into fragment.firstElementChild@data-index
            put fragment before me
          end
        end
      end

      def snakeIcon(direction)
        if direction == 'up' 
          return '▲'
        else if direction == 'down' 
          return '▼'
        else if direction === 'right' 
          return '▶'
        else if direction === 'left'
          return '◀'
        else 
          return 'idk'
        end
      end

      def randomizeFood()
        get the <[data-cell='empty']/> in me
        if the result's length > 0
          set el to random in result
          put 'food' into el's @data-cell 
        else
          alert('Grid is maxed out, cannot spawn new food, good job!')
        end
      end

      def move()
        log 'TODO: move'
        set @data-time-elapsed to 0
      end

      def animate(time)
        if not @data-paused
          get @data-time-elapsed as Number
          set @data-time-elapsed to it + (time - @data-time-previous)
        end

        set @data-time-previous to time

          // the snake moves every second minus 10ms for each speed level
        if @data-time-elapsed > (1000 - (@data-speed * 10))
          move()
        end
        call requestAnimationFrame(animate)
      end
     
    </script>

    <!-- Docs: https://tailwindcss.com/ -->
  </head>

  <body 
    autofocus 
    tabindex="-1"
    data-direction="right"
    data-speed="0"
    data-time-elapsed="0"
    data-time-previous="0"
    _="
      on snake:init
        randomizeFood()
        call requestAnimationFrame(animate)
      end

      on keydown[key=='h'] 
        set @data-dir to 'left'
      end

      on keydown[key=='l'] 
        set @data-dir to 'right'
      end

      on keydown[key=='j'] 
        set @data-dir to 'down'
      end

      on keydown[key=='k'] 
        set @data-dir to 'up'
      end

      on keydown[key==' ']
        log 'TODO: Move'
      end

      on keydown[key=='Enter']
        toggle @data-paused
        if @data-paused
          log 'paused'
        else 
          log 'unpaused'
        end
      end
    "
  >
    <main class="flex flex-col items-center gap-4 mt-4"> 
      <div>
        Score:
        <span id="score"></span>
      </div>
      <table class="border-spacing-0 border-collapse">
        <tbody>
          <template _="install Repeat(amount: 10)">
            <tr class="border border-neutral">
              <template _="install Repeat(amount: 10)">
                <td class="border border-neutral">
                  <span class="flex h-7 w-7 items-center justify-center">
                    <!--style="content: attr(data-cell)"-->
                    <pre
                      data-cell='empty'
                      class="text-lg"
                      _="
                        init
                          get the closest <td/> 
                          set column to its@data-index
                          get the closest <tr/>
                          set row to its@data-index
                          put `cell-${column}-${row}` into my@id

                          if column == 0 and row == 0 
                            put 'snake-head' into @data-cell
                          end
                          if column == 9 and row == 9 
                            send snake:init to the closest <body />
                          end
                        end

                        on mutation of @data-cell
                          if @data-cell == 'empty' 
                            put ' ' into me
                          else if @data-cell == 'food'
                            put '$' into me
                          else if @data-cell == 'snake-body'
                            put '=' into me
                          else if @data-cell == 'snake-head'
                            get @data-direction of the closest <body />
                            put snakeIcon(the result) into me
                          end
                        end
                      "
                    >
                    </pre>
                  </span>
                </td>
              </template>
            </tr>
          </template>
        </tbody>
      </table>
    </main>
  </body>
  <script>
    // utilities
        // define object stores
    document.addEventListener('alpine:init', () => {
      Alpine.store('snake', {
        init() {
          this.segments[0] = ({ 
            x: 0,
            y: 0,
            icon: snake_icon('right'),
            direction: 'right',
          });

          let snake = this;
          function render(time) {
            snake.animate(time)
            requestAnimationFrame(render);
          }
         
          requestAnimationFrame(render);
        },
        speed: 0,
        score: 0,
        segments: Array.from({ length: 1 }), // TODO: circular buffer
        steer(direction) {
          this.segments[0].direction = direction;
          this.segments[0].icon = snake_icon(direction);
        },
        move() {
          this.time.elapsed = 0;

          let last = this.segments[this.segments.length - 1];
          Alpine.store('grid')[last.y][last.x] = EMPTY;
          for (let i = 0; i < this.segments.length; i++) {
            let segment = this.segments[i];
            if (segment.direction === 'left') {
              if (segment.x === 0) {
                segment.x = 9;
              } else {
                segment.x -= 1;
              }
            } else if (segment.direction === 'right') {
              if (segment.x === 9) {
                segment.x = 0;
              } else {
                segment.x += 1;
              }
            } else if (segment.direction === 'up') {
              if (segment.y === 0) {
                segment.y = 9;
              } else {
                segment.y -= 1;
              }
            } else if (segment.direction === 'down') {
              if (segment.y === 9) {
                segment.y = 0;
              } else {
                segment.y += 1;
              }
            }
            if (i > 0) {
              segment.direction = this.segments[i-1].direction;
              segment.css_rotate = segment.direction == 'up' || segment.direction == 'down';
              segment.icon = snake_icon(segment.direction);
            }
            const { x, y, direction, css_rotate, icon } = segment;
            console.log({ x, y, direction, css_rotate, icon });
            Alpine.store('grid')[segment.y][segment.x] = segment;
            //i > 0 ? '=' : snake_icon(segment.direction);
          }
          let food = Alpine.store('food');
          let head = this.segments[0];
          if (head.x == food.x && head.y == food.y) {
            this.score += 1;
            this.speed += 1;
            let last = this.segments[this.segments.length - 1];
            console.log("last", last);
            let copy = Alpine.reactive({...last});
            copy.direction = '';
            copy.icon = '%';
            console.log("copy", copy);
            this.segments.push(copy);

            food.randomize();
          }
        },

        // times are in milliseconds
        time: {
          paused: false,
          // total time since last movement
          elapsed: 0,
          // timestamp of previous animation frame
          previous: 0,
        },
        animate(time) {
          if (!this.time.paused) {
            this.time.elapsed += time - this.time.previous;
          }
          this.time.previous = time;

          // the snake moves every second minus 10ms for each speed level
          if (this.time.elapsed > (1000 - this.speed * 10)) {
            this.move();
          }
        }
      });
    })
  </script>
</html>
