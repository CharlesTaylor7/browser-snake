<!DOCTYPE html>
<html>
  <head>
    <title>Snake</title>

    <!-- Docs: https://alpinejs.dev/start-here -->
    <script src="//unpkg.com/alpinejs" defer></script>

    <!-- Docs: https://tailwindcss.com/ -->
    <script src="//cdn.tailwindcss.com"></script>
  </head>

  <body 
    autofocus 
    tabindex="-1"
    x-data
    x-on:keydown.space="$store.snake.move()"
    x-on:keydown.h="$store.snake.steer('left')"
    x-on:keydown.l="$store.snake.steer('right')"
    x-on:keydown.k="$store.snake.steer('up')"
    x-on:keydown.j="$store.snake.steer('down')"
  >
    <main class="flex flex-col items-center gap-4 mt-4"> 
      <div>
        Score:
        <span x-text="$store.snake.score"></span>
      </div>
      <table class="border-spacing-0 border-collapse">
        <tbody>
          <template x-for="row in 10">
            <tr class="border border-neutral">
              <template x-for="col in 10">
                <td class="border border-neutral">
                  <span class="flex h-7 w-7 items-center justify-center">
                    <pre
                      class="text-lg"
                      x-bind:class="$store.grid[row - 1][col - 1].css_rotate ? 'rotate-90' : ''"
                      x-text="$store.grid[row - 1][col - 1].icon"
                    >
                    </pre>
                  </span>
                </td>
              </template>
            </tr>
          </template>
        </tbody>
      </table>
    </main>
  </body>
  <script>
    // utilities
    function snake_icon(direction) {
      if (direction === 'up') {
        return '▲';
      } else if (direction === 'down') {
        return '▼';
      } else if (direction === 'right') {
        return '▶';
      } else if (direction === 'left') {
        return '◀';
      } else {
        return 'idk';
      }
    }
    // define object stores
    document.addEventListener('alpine:init', () => {
      Alpine.store('empty', {
        icon: ' ',
      });
      Alpine.store('grid', Array.from({length: 10}, () => Array.from({ length: 10 }, () => ' ')));
      Alpine.store('food', {
        init() {
          this.randomize();
        },
        x: 0,
        y: 0,
        icon: '$',
        randomize() {
          while (true) {
            let x = Math.floor(Math.random() * 10);
            let y = Math.floor(Math.random() * 10);
            // ensure the food doesn't respawn in the same location 
            if (x != this.x || y != this.y) {
              this.x = x;
              this.y = y;
              let grid = Alpine.store('grid');
              grid[y][x] = this;
              break;
            }
          }
        }
      });
      Alpine.store('snake', {
        init() {
          this.segments.push({ 
            x: 0,
            y: 0,
            icon: snake_icon('right'),
            direction: 'right',
          });

          let snake = this;
          function render(time) {
            snake.animate(time)
            requestAnimationFrame(render);
          }
         
          requestAnimationFrame(render);
        },
        speed: 0,
        score: 0,
        segments: Array.from({ length: 100 }),
        steer(direction) {
          this.segments[0].direction = direction;
          this.segments[0].icon = snake_icon(direction);
        },
        move() {
          this.time.elapsed = 0;

          let last = this.segments[this.segments.length - 1];
          Alpine.store('grid')[last.y][last.x] = ' ';
          for (let i = 0; i < this.segments.length; i++) {
            let segment = this.segments[i];
            if (segment.direction === 'left') {
              if (segment.x === 0) {
                segment.x = 9;
              } else {
                segment.x -= 1;
              }
            } else if (segment.direction === 'right') {
              if (segment.x === 9) {
                segment.x = 0;
              } else {
                segment.x += 1;
              }
            } else if (segment.direction === 'up') {
              if (segment.y === 0) {
                segment.y = 9;
              } else {
                segment.y -= 1;
              }
            } else if (segment.direction === 'down') {
              if (segment.y === 9) {
                segment.y = 0;
              } else {
                segment.y += 1;
              }
            }
            if (i > 0) {
              segment.direction = this.segments[i-1].direction;
              segment.css_rotate = segment.direction == 'up' || segment.direction == 'down';
            }
            Alpine.store('grid')[segment.y][segment.x] = segment;
            //i > 0 ? '=' : snake_icon(segment.direction);
          }
          let food = Alpine.store('food');
          let head = this.segments[0];
          if (head.x == food.x && head.y == food.y) {
            this.score += 1;
            this.speed += 1;
            let last = this.segments[this.segments.length - 1];
            let copy = structuredClone({...last});
            copy.direction = '';
            this.segments.push(copy);

            food.randomize();
          }
        },

        // times are in milliseconds
        time: {
          // total time since last movement
          elapsed: 0,
          // timestamp of previous animation frame
          previous: 0,
        },
        animate(time) {
          this.time.elapsed += time - this.time.previous;
          this.time.previous = time;

          // the snake moves every second minus 10ms for each speed level
          if (this.time.elapsed > (1000 - this.speed * 10)) {
            this.move();
            console.log(this.segments);
          }
        }
      });
    })
  </script>
</html>
