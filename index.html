<!DOCTYPE html>
<html>
  <head>
    <title>Snake</title>

    <!-- Docs: https://alpinejs.dev/start-here -->
    <script src="//unpkg.com/alpinejs" defer></script>

    <!-- Docs: https://tailwindcss.com/ -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body 
    autofocus 
    tabindex="-1"
    x-data
    x-on:keydown.space="$store.snake.move()"
    x-on:keydown.h="$store.snake.direction = 'left'"
    x-on:keydown.l="$store.snake.direction = 'right'"
    x-on:keydown.k="$store.snake.direction = 'up'"
    x-on:keydown.j="$store.snake.direction = 'down'"
  >
    <main class="flex flex-col items-center gap-4 mt-4"> 
      <div>
        Score:
        <span x-text="$store.snake.score"></span>
      </div>
      <table 
        class="border-spacing-0"
      >
        <tbody>
          <template x-for="row in 10">
            <tr class="border border-neutral" >
              <template x-for="col in 10">
                <td class="p-4 border border-neutral">
                  <span 
                    x-text="
                      if ($store.snake.x === col - 1 && $store.snake.y === row - 1) {
                       return $store.snake.icon()
                      } else if ($store.food.x === col - 1 && $store.food.y === row - 1) {
                        return row + col;
                      } else {
                        return '__'
                      }
                    "
                  >
                  </span>
                </td>
              </template>
            </tr>
          </template>
        </tbody>
      </table>
    </main>
  </body>
  <script>
    // define object stores
    document.addEventListener('alpine:init', () => {
      Alpine.store('food', {
        x: 0,
        y: 0,
        randomize() {
          while (true) {
            let x = Math.floor(Math.random() * 10);
            let y = Math.floor(Math.random() * 10);
            // ensure the food doesn't respawn in the same location 
            if (x != this.x || y != this.y) {
              this.x = x;
              this.y = y;
              break;
            }
          }
        }
      });
      Alpine.store('snake', {
        x: 0,
        y: 0,
        speed: 0,
        score: 0,
        direction: 'right',
        lastMovedTime: 0,
        icon() {
          if (this.direction === 'up') {
            return '▲';
          } else if (this.direction === 'down') {
            return '▼';
          } else if (this.direction === 'right') {
            return '▶';
          } else if (this.direction === 'left') {
            return '◀';
          } else {
            return 'idk';
          }
        },
        move() {
          if (this.direction == 'left') {
            this.moveLeft();
          } else if (this.direction == 'right') {
            this.moveRight();
          } else if (this.direction == 'up') {
            this.moveUp();
          } else if (this.direction === 'down') {
            this.moveDown();
          }

          let food = Alpine.store('food');
          if (this.x == food.x && this.y == food.y) {
            this.score += 1;
            this.speed += 1;

            food.randomize();
          }
        },
        moveLeft() {
          if (this.x === 0) {
            this.x = 9;
          } else {
            this.x -= 1;
          }
        },

        moveRight() {
          if (this.x === 9) {
            this.x = 0;
          } else {
            this.x += 1;
          }
        },

        moveUp() {
          if (this.y === 0) {
            this.y = 9;
          } else {
            this.y -= 1;
          }
        },

        moveDown() {
          if (this.y === 9) {
            this.y = 0;
          } else {
            this.y += 1;
          }
        },

        animate(time) {
          // the snake moves every second minus 10ms for each speed level
          if (time - snake.lastMovedTime > (1000 - snake.speed * 10)) {
            snake.move();
            snake.lastMovedTime = time;
          }
        }
      });

      // initialize the game
      Alpine.store('food').randomize();

      let snake = Alpine.store("snake");

      function render(time) {
        snake.animate(time)
        requestAnimationFrame(render);
      }
     
      requestAnimationFrame(render);
    })
  </script>
</html>
